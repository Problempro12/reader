<!DOCTYPE html>
<html>
<head>
    <title>Test Archive Processing</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <h1>Archive Processing Test</h1>
    <button onclick="testArchive()">Test Archive Processing</button>
    <div id="output"></div>

    <script>
        // Полное содержимое книги ID 32 из базы данных
        const testContent = 'UEsDBBQAAAAIADGF4kAyVhXwWpwBAM9EAgBMAAAAS3V6bWluYV9MeXVibHl1X3RlYnlhX1BldHJhX3R2b3JlbmUuX1B1c2hraW5za2llX21lc3RhX0xlbmluZ3JhZGEuMzgyMDc0LmZiZOz92dLzWpomhp3rKnbkgU9QXRgJEHJ2KQBinghiBk4UADEQ8wwCOOrqDll2WJYi5AM7pLB9C11VXVK7h9QtZN6RF7//3zv3zsquqpYcdh8k//h+EsNa613v+DxYBPjr/2Jvmx+2bJrLvvunv0L/HPnVD1n37NOyK/7pr9Yl/yfXX/0Xf/Gf/Voonws4g+37+gfQopv/6a9eyzL85zD8fr//vJjKZJ2z6c+nFQZH4fzb2Qk4G8Y+XX41+c+bXzR643/eTwWM0jQN703Z1b/6i//sh1+n2fycyuHTHGz+8OulXJrsn5Rd3n82f/h1kXVT9hfzs/wvX+W89NPxa/jbrp8d7fou/y+Tsi+meHj9Aw4Aw4L1HwEPR0CuDQ+H7Ksi4DGQuALA0JD+wJMWoyEYAezrAeEMBrwmTApxwD46kBMJngcBMPCYQZBWNUE+P2JzlQ8JxvDg/iVhYJ8fASeEBjgIhgfFQgAGuPIICEYA+QII0mYSODgdaX0akg4P1hskjACKiRGk/cCQ6yAtPIOvg7RoCMZAMAKEF9JCHQaCgWMNACPNckMwFGjdCkGa/MdgIRgeC24zBg1H4iEYEgVuCzBWMUgIBp7PAYwgEjyXRsLAc5YAhkMhMRAMgwLXgQOGBxaCAeEFUGtYAgQDz80BGA68dkxa/MBgUBAMPBYADIPF4SEYHtJvJAcBkg6PhMgVabkCgiHhSDBXBAx4rzMJwyLAPJMGPxKKgXQJacssAhRrkDDwHAqCJIAIKIYE9xuCFO0iIRgODa6DlBkDwbDgPifNFIB8VhIG3veFIN0qgYXkxaNBvjyAkQIkEEaiGZwOqAFyvUgEAbQuiSDt1QXrDQBDQdoCYGDZADAsCpIXAV6bBTAkON7fxFCQdCgs5HpRaPDaDgmDjAUE4FGDfD0SRoDWiyFA6iXdpAsuj6Q2wPyhIfEvCcOhwDKJRqMh3KMxCLDORqABZQLJi0XhsRAMHFcAGB687owgbcf83Sa7u5rbORBdmRlJzy+w8yGS7pY5epSZ0c3d3NV96w4aQBSZGYWElDSVmRn/H1BLAQIAABQAAAAIADGF4kAyVhXwWpwBAM9EAgBMAAAAAAAAAAAAAAAAAAAAAABLdXptaW5hX0x5dWJseXVfdGVieWFfUGV0cmFfdHZvcmVuZS5fUHVzaGtpbnNraWVfbWVzdGFfTGVuaW5ncmFkYS4zODIwNzQuZmJkUEsBAgAAFAAAAAgAonPiQMZKdRcNFxAAzscRAEwAAAAAAAAAAAAAAAAAxJwBAEt1em1pbmFfTHl1Ymx5dV90ZWJ5YV9QZXRyYV90dm9yZW5lLl9QdXNoa2luc2tpZV9tZXN0YV9MZW5pbmdyYWRhLjM4MjA3NC5wZGZQSwUGAAAAAAIAAgD0AAAAO7QRAAAA';

        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += '<p>' + message + '</p>';
            console.log(message);
        }

        function isBase64Archive(content) {
            try {
                if (!content || content.length < 10) {
                    log('Content too short: ' + content.length);
                    return false;
                }
                
                const decoded = atob(content.substring(0, 100));
                const isPK = decoded.charCodeAt(0) === 0x50 && decoded.charCodeAt(1) === 0x4B;
                
                log('Base64 archive check: contentStart=' + content.substring(0, 20) + ', firstBytes=[' + decoded.charCodeAt(0) + ',' + decoded.charCodeAt(1) + '], isPK=' + isPK);
                
                return isPK;
            } catch (error) {
                log('Base64 decode error: ' + error.message);
                return false;
            }
        }

        async function extractTextFromArchive(base64Content) {
            try {
                log('Starting archive extraction, content length: ' + base64Content.length);
                
                const binaryString = atob(base64Content);
                log('Base64 decoded, binary length: ' + binaryString.length);
                
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                log('Converted to bytes array, first 10 bytes: ' + Array.from(bytes.slice(0, 10)).map(b => '0x' + b.toString(16)).join(','));
                
                const zip = new JSZip();
                log('Loading ZIP archive...');
                const zipContent = await zip.loadAsync(bytes);
                log('ZIP loaded successfully');
                
                const allFiles = Object.keys(zipContent.files);
                log('Files in archive: ' + allFiles.join(', '));
                
                const textFiles = allFiles.filter(filename => {
                    return filename.endsWith('.fb2') || 
                           filename.endsWith('.txt') || 
                           filename.endsWith('.xml') ||
                           filename.endsWith('.epub') ||
                           !filename.includes('/');
                });
                log('Text files found: ' + textFiles.join(', '));
                
                if (textFiles.length === 0) {
                    log('No text files found in archive');
                    return 'В архиве не найдено текстовых файлов';
                }
                
                const file = zipContent.files[textFiles[0]];
                log('Extracting content from file: ' + textFiles[0]);
                const content = await file.async('text');
                log('Content extracted, length: ' + content.length + ', first 100 chars: ' + content.substring(0, 100));
                
                return content;
            } catch (err) {
                log('Error extracting from archive: ' + err.message);
                return 'Ошибка при обработке архива: ' + err.message;
            }
        }

        async function testArchive() {
            document.getElementById('output').innerHTML = '';
            log('=== Starting Archive Test ===');
            
            const isArchive = isBase64Archive(testContent);
            log('Is archive: ' + isArchive);
            
            if (isArchive) {
                const extracted = await extractTextFromArchive(testContent);
                log('Extraction result: ' + extracted.substring(0, 200) + '...');
            }
            
            log('=== Test Complete ===');
        }
    </script>
</body>
</html>