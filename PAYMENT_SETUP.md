# Настройка платежной системы ЮKassa

## Обзор

В проекте реализована интеграция с платежной системой ЮKassa для продажи премиум-подписок. Система включает:

- Модели для тарифных планов и платежей
- API endpoints для создания и обработки платежей
- Webhook обработчик для уведомлений от ЮKassa
- Красивый интерфейс в настройках пользователя

## Настройка

### 1. Получение ключей ЮKassa

1. Зарегистрируйтесь в [ЮKassa](https://yookassa.ru/)
2. Создайте магазин в личном кабинете
3. Получите `shop_id` в разделе "Настройки → Магазин"
4. Создайте секретный ключ в разделе "Интеграция → Ключи API"

### 2. Настройка переменных окружения

Скопируйте файл `.env.example` в `.env` и заполните:

```bash
cp backend/.env.example backend/.env
```

Отредактируйте `.env` файл:

```env
# ЮKassa settings
YOOKASSA_SHOP_ID=ваш_shop_id
YOOKASSA_SECRET_KEY=ваш_секретный_ключ
YOOKASSA_WEBHOOK_URL=https://ваш-домен.com/api/payments/webhook/
```

### 3. Настройка webhook

В личном кабинете ЮKassa:
1. Перейдите в "Интеграция → Уведомления"
2. Добавьте URL: `https://ваш-домен.com/api/payments/webhook/`
3. Выберите события: `payment.succeeded`, `payment.canceled`

### 4. Запуск миграций

```bash
cd backend
python manage.py migrate
python manage.py seed_premium_plans
```

## API Endpoints

### Получение тарифных планов
```
GET /api/payments/plans/
```

### Создание платежа
```
POST /api/payments/create/
{
  "plan_id": 1
}
```

### Список платежей пользователя
```
GET /api/payments/list/
```

### Статус платежа
```
GET /api/payments/status/{payment_id}/
```

### Webhook (для ЮKassa)
```
POST /api/payments/webhook/
```

## Модели

### PremiumPlan
- `name` - название плана
- `description` - описание
- `price` - цена
- `duration_days` - длительность в днях
- `features` - список особенностей (JSON)

### Payment
- `user` - пользователь
- `plan` - тарифный план
- `yookassa_payment_id` - ID платежа в ЮKassa
- `amount` - сумма
- `status` - статус платежа
- `payment_url` - URL для оплаты

## Функциональность

### Для пользователей
- Просмотр доступных тарифных планов
- Создание платежа
- История платежей
- Автоматическая активация премиум после оплаты

### Для администраторов
- Управление тарифными планами через Django Admin
- Просмотр всех платежей
- Мониторинг webhook уведомлений

## Тестирование

### Тестовые данные
По умолчанию создаются 3 тарифных плана:
- Премиум на месяц (299₽)
- Премиум на 3 месяца (799₽) - популярный
- Премиум на год (2999₽)

### Тестовые ключи
Для тестирования используйте тестовые ключи ЮKassa:
- Shop ID: `test_shop_id`
- Secret Key: `test_secret_key`

## Безопасность

1. **Никогда не коммитьте** файл `.env` в репозиторий
2. Используйте HTTPS в продакшене
3. Настройте правильные CORS настройки
4. Валидируйте webhook уведомления

## Troubleshooting

### Платеж не создается
- Проверьте правильность ключей ЮKassa
- Убедитесь, что shop_id и secret_key корректны

### Webhook не работает
- Проверьте доступность URL из интернета
- Убедитесь, что URL возвращает 200 OK
- Проверьте логи в Django

### Премиум не активируется
- Проверьте обработку webhook
- Убедитесь, что платеж имеет статус `succeeded`
- Проверьте логи активации премиум

## Дополнительные возможности

### Автопродление
Можно добавить автопродление подписки через:
- Сохранение способа оплаты в ЮKassa
- Автоматическое создание платежей

### Уведомления
Можно добавить email уведомления:
- При успешной оплате
- Перед истечением подписки
- При отмене платежа

### Аналитика
Можно добавить:
- Статистику продаж
- Популярные тарифы
- Конверсию платежей
